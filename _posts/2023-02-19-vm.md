# Virtual Machine

è™šæ‹Ÿæœºæ–¹æ¡ˆï¼Œå¸®ä½ æ‘†è„±`VM Ware`å’Œ`Virtual Box`ã€‚

Windowså†è§ğŸ‘‹ï¼

## Get Started

ä¸‹è½½å®‰è£…åç»­éœ€è¦çš„å·¥å…·ï¼š

**MacOs**

```sh
brew install gcc qemu virt-manager
brew services restart libvirt
```

**Linux**

```sh
sudo pacaman -S qemu virt-manager virt-viewer dnsmasq vde2 bridge-utils openbsd-netcat libguestfs
systemctl start libvirtd
systemctl enable libvirtd
```

ä¸‹è½½ubuntué•œåƒå¹¶é‡å‘½åä¸º`ubuntu.iso`ã€‚

æœ‰`qemu`å·²ç»è¶³å¤Ÿè®©æˆ‘ä»¬å¯åŠ¨è™šæ‹Ÿæœºï¼š

```sh
# åˆ›å»ºå­˜å‚¨çš„ä»‹è´¨
qemu-img create -f qcow2 ubuntu.qcow2 20G

# æŒ‡å®šé•œåƒå»å®‰è£…
qemu-system-x86_64 \
    -machine type=q35,accel=hvf \
    -smp 2 \
    -cpu host \
    -hda ubuntu.qcow2 \
    -cdrom ./ubuntu.iso \
    -m 4G

# å¯åŠ¨è™šæ‹Ÿæœº
# ç”±äºä½¿ç”¨äº†MacOSçš„Hypervisor.framework
# éœ€è¦sudoå‘½ä»¤
sudo qemu-system-x86_64 \
  -machine type=q35,accel=hvf \
  -M accel=hvf \
  -cpu host \
  -smp 6 \
  -m 16G \
  -hda ~/vm/ubuntu.qcow2 \
  -vga virtio \
  -usb \
  -device usb-tablet \
  -display default,show-cursor=on \
  -nic vmnet-bridged,ifname=en0
```

å¾ˆæ˜æ˜¾ä¸Šè¿°æ“ä½œå¾ˆç¹çï¼Œä½¿ç”¨`virt-manager`å¯ä»¥ç®€åŒ–ä¸Šè¿°æ“ä½œæµç¨‹ï¼Œ

åŒæ—¶æä¾›æš‚åœï¼ˆsuspendï¼‰å’Œæ¢å¤ï¼ˆresumeï¼‰çš„ç­‰å…¶ä»–åŠŸèƒ½ã€‚

å‚è€ƒ[Ubuntu VM on macoS with libvirt + QEMU](https://www.naut.ca/blog/2020/08/26/ubuntu-vm-on-macos-with-libvirt-qemu/)

é¦–å…ˆåˆ›å»º`ubuntu.xml`æ–‡ä»¶ï¼š

```xml
<domain type='hvf' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>
	<name>ubuntu</name>
	<uuid>2005CB24-522A-4485-9B9A-E60A61D9F8CF</uuid>
	<memory unit='GB'>4</memory>
	<cpu mode='custom'>
		<model>Westmere</model>
	</cpu>
	<vcpu>4</vcpu>
	<features>
		<acpi />
		<apic />
	</features>
	<os>
		<type arch='x86_64' machine='q35'>hvm</type>
		<bootmenu enable='yes' />
	</os>
	<clock offset='localtime' />
	<on_poweroff>destroy</on_poweroff>
	<on_reboot>restart</on_reboot>
	<on_crash>destroy</on_crash>
	<pm>
		<suspend-to-mem enabled='no' />
		<suspend-to-disk enabled='no' />
	</pm>
	<devices>
		<emulator>/usr/local/bin/qemu-system-x86_64</emulator>
		<controller type='usb' model='ehci' />
		<disk type='file' device='disk'>
			<driver name='qemu' type='qcow2' />
			<source file='/Users/ming/vms/ubuntu.qcow2' />
			<target dev='vda' bus='virtio' />
		</disk>
		<disk type='file' device='cdrom'>
			<source file='/Users/ming/vms/ubuntu.iso' />
			<target dev='sdb' bus='sata' />
		</disk>
		<console type='pty'>
			<target type='serial' />
		</console>
		<input type='tablet' bus='usb' />
		<input type='keyboard' bus='usb' />
		<graphics type='vnc' port='5900' listen='127.0.0.1' />
		<video>
			<model type='virtio' vram='16384' />
		</video>
	</devices>
	<seclabel type='none' />
	<qemu:commandline>
		<qemu:arg value='-machine' />
		<qemu:arg value='type=q35' />
	</qemu:commandline>
</domain>
```

libvirtæ— æ³•é…ç½®ç½‘ç»œï¼ŒåŸå› ä¸æ˜ï¼Œç½‘ä¸Šå‚è€ƒä¹Ÿæ¯”è¾ƒå°‘ã€‚

ç„¶åä½¿ç”¨ä¸‹è¿°å‘½ä»¤å®šä¹‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼š

```sh
virtsh define ubuntu.xml
```

ç„¶åå¯åŠ¨è¯¥è™šæ‹Ÿæœºï¼š

```sh
virsh start ubuntu
```

è¿™é‡Œçš„`ubuntu`ä¸º`ubuntu.xml`æ–‡ä»¶é‡Œçš„`name`æ ‡ç­¾å†…å®¹ã€‚

å½“ä½ å¯åŠ¨è™šæ‹Ÿæœºæ—¶ä½ ä¼šå‘ç°ï¼Œè™šæ‹Ÿæœºæ²¡æœ‰åƒ`qemu`ä¸€æ ·å¼¹å‡ºçª—å£ï¼Œå¦‚æœä½ ä»”ç»†æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼Œä½ ä¸ºå…¶é…ç½®äº†

```xml
		<graphics type='vnc' port='5900' listen='127.0.0.1' />
```

æ‰€ä»¥è¯·ä½¿ç”¨VNCå·¥å…·è¿æ¥æŸ¥çœ‹ï¼Œè¿™é‡Œæ¨èå®‰è£…`tigervnc-viewer`å¼€æºå·¥å…·ï¼š

```sh
brew install tigervnc-viewer
```

å½“ä½ æƒ³é€€å‡ºï¼Œä½ å¯ä»¥ä½¿ç”¨

```sh
virsh shutdown ubuntu
virsh destroy ubuntu
# ä¿å­˜ï¼Œä¸‹æ¬¡å¯ä»¥ç”¨startç»§ç»­è¿è¡Œ
virsh managedsave ubuntu
```

`qemu`å’Œ`libvirt`å¯é…ç½®å‚æ•°æœ‰å¾ˆå¤šï¼Œå› æ­¤å¯ç©å¾ˆé«˜ï¼Œæˆ‘ä¼šæ…¢æ…¢æ•´ç†ä¸€äº›ç›¸å…³å‚è€ƒæ”¾åœ¨è¿™é‡Œï¼š

[QEMU documentation](https://www.qemu.org/docs/master/)

QEMUå®˜æ–¹æ–‡æ¡£

[QEMU WiKi](https://wiki.qemu.org)

QEMU WiKi ä¸ä»…é™äºæ–‡æ¡£ï¼Œæˆ‘å»ºè®®ä½œä¸ºæ–‡æ¡£çš„è¡¥å……

[QEMU - Arch WiKi](https://wiki.archlinux.org/title/QEMU)

ArchLinuxæ–‡æ¡£å‘æ¥é«˜è´¨é‡

[Domain XML format](https://libvirt.org/formatdomain.html)

libvirtå®˜æ–¹çš„xmlæ–‡ä»¶é…ç½®æ–‡æ¡£

[QEMU command-line passthrough](https://libvirt.org/kbase/qemu-passthrough-security.html)

libvirtå®˜æ–¹é’ˆå¯¹qemuå‘½ä»¤è¡Œä¼ å‚çš„æ–‡æ¡£

[Libvirt Hypervisor](https://libvirt.org/drvqemu.html)

ä¼—æ‰€å‘¨çŸ¥ Hypervisor æ˜¯è¿è¡Œå’Œç®¡ç†å¤šä¸ªè™šæ‹Ÿæœºçš„ç¨‹åº

libvirtæä¾›äº†Hypervisorçš„é…ç½®æ–‡æ¡£

[QEMU Switch To Libvirt](https://wiki.libvirt.org/page/QEMUSwitchToLibvirt)

å°†QEMUè½¬æ¢æˆLibvirt

## Learn Utils

### QEMU

`-cpu host` 

(Recommended) Emulate the host processor.

MacOSåœ¨æŒ‡å®š`-smp`åä¸è®¾ç½®æ”¹å‚æ•°ä¼šæŠ¥é”™ï¼š

```
qemu-system-x86_64: warning: host doesn't support requested feature: CPUID.80000001H:ECX.svm [bit 2]
```

`-smp <NUMBER>` 

Specify the number of cores the guest is permitted to use.

-accel=hvfï¼Œhvfå°±æ˜¯qemuæ”¯æŒmac osåŸç”Ÿhypervisorçš„é€‰é¡¹ã€‚

https://www.arthurkoziel.com/running-virt-manager-and-libvirt-on-macos/

**-nic**

NIC Network Interface Controller

å¯ä»¥åŒæ—¶åˆ›å»ºå‰ç«¯å’Œåç«¯

https://www.qemu.org/2018/05/31/nic-parameter/

æ¡¥æ¥çš„æ–¹å¼é“¾æ¥ï¼Œéœ€è¦sudoæƒé™

```sh
-nic vmnet-bridged,ifname=en0
```



**-netdev**

æ˜¯æ–°çš„å‚æ•°

åªå¯ä»¥åˆ›å»ºåç«¯

***-net*** 

æ˜¯è¿‡æ—¶çš„å‚æ•°ï¼Œåº”é¿å…ä½¿ç”¨

å¯ä»¥åˆ›å»ºå‰åç«¯

qemu / kvm æ˜¯ linux çš„å®ç°

qemu / hypervisor æ˜¯ mac çš„å®ç°ï¼ˆ[Apple Developer Documentation](https://link.zhihu.com/?target=https%3A//developer.apple.com/documentation/hypervisor)ï¼‰

QEMUçª—å£`ctrl + alt +2`åˆ‡æ¢åˆ°monitorï¼Œ`ctrl + alt + 1`åˆ‡æ¢åˆ°è™šæ‹Ÿæœºã€‚

`savevm`ä¿å­˜ 

`loadvm`è½½å…¥

`info snapshot`æ˜¾ç¤º

macosä¸‹savevmä¼šå´©æºƒé€€å‡ºï¼Œæ— æ³•ä¿å­˜

## å¸¸è§ä¸¾ä¾‹

å¯åŠ¨å¹¶è®¾ç½®ç«¯å£è½¬å‘

å‚æ•°ä»‹ç»

```sh
-machine accel=hvf
```

HVF is a QEMU accelerator on [macOS](https://wiki.qemu.org/Hosts/Mac) that employs [Hypervisor.framework](https://developer.apple.com/documentation/hypervisor)	å‚è€ƒï¼šhttps://wiki.qemu.org/Features/HVF

## æŠ€å·§

å…³äºåœ¨macosä¸Šåˆ›å»ºç½‘ç»œæ¡¥æ¥

https://taoshu.in/unix/qemu-bridge-on-macos.html

å¦‚æœæƒ³è®©å¤–ç•Œç›´æ¥è®¿é—®è™šæ‹Ÿæœºï¼Œæœ€ç®€å•çš„åŠæ³•æ˜¯ä½¿ç”¨æ¡¥æ¥ã€‚

ç›®å‰ç½‘ä¸Šå¤šæ•°æ˜¯åˆ©ç”¨tapæ¨¡å¼ã€‚

macosä¸æ”¯æŒtapè®¾å¤‡éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹tuntapï¼Œ

å› ä¸ºæ–°çš„macoså·²ç»å¯ç”¨çš„å†…æ ¸æ‹“å±•ï¼Œtuntapä¸å†ç»§ç»­å¼€å‘ã€‚

macos ä» 10.10 Yosemite å¼€å§‹æä¾› Hypervisor.frameworkï¼Œè¿™æ˜¯ BSD å†…æ ¸åŸç”Ÿçš„è™šæ‹ŸåŒ–æ¡†æ¶ï¼Œæœ‰ç‚¹ç±»ä¼¼ Linux çš„ KVM æ¨¡å—ã€‚Hypervisor.framework æ”¯æŒä¸ºè™šæ‹Ÿæœºåˆ›å»ºæ¡¥æ¥ç½‘ç»œã€‚qeum å¤§çº¦åœ¨ 2021 å¹´å¹´åº•å¼€å§‹æ”¯æŒ Hypervisor.frameworkã€‚

```sh
sudo qemu-system-x86_64 path/to/disk \
         -M accel=hvf \
	 -cpu host -smp cpus=8 -m 256 \
	 -nic vmnet-bridged,ifname=en0
```

virt-manger ç®¡ç†qemu

https://www.arthurkoziel.com/running-virt-manager-and-libvirt-on-macos/

## æ€»ç»“

ç»¼ä¸Šqemuå’Œlibvirtåœ¨macä¸‹ä½“éªŒä¸å¥½ï¼Œè¿˜æ˜¯è¦linuxä¸‹ä½¿ç”¨ã€‚
