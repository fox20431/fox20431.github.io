---
title: what happend to dns in proxy
date: 2023-09-25
---

# What happend to dns in proxy

参考文章：https://blog.skk.moe/post/what-happend-to-dns-in-proxy/

以下内容参考原型为：clash+v2ray

## DNS原理

想要理解Clash的DNS相关的配置，首先要弄明白为什么我们需要DNS的工作原理。

**由于 TCP/IP 的协议特性，在应用发起 TCP 连接时，会先发出一个 DNS question（发一个 IP Packet），获取要连接的服务器的 IP 地址，然后直接向这个 IP 地址发起连接。**

浏览器有自己的DNS缓存机制，操作系统也有自己的DNS缓存机制，当我们在浏览器发送一个 DNS question 时：

1. 浏览器首先会查询自己的DNS；
2. 浏览器查询不到后，会调用操作系统 `getaddrinfo` 方法，向操作系统寻求解析结果；
3. 操作系统首先会查询自身的DNS缓存；
4. 操作系统在自身DNS缓存找不到的情况下，根据操作系统中网络设置的DNS地址，向DNS服务器请求结果；
5. DNS服务器也找不到的情况下，如果它存在更上一级的DNS服务器，将继续交给它本身的DNS服务器，以此类推；
6. 直到找到结果并返回，或遍历无结果，该域名无法找到IP。

## 不同代理方式下DNS解析行为

不同代理的代理方式，其对应的DNS解析行为也不同。

### 全局流量转发代理

首先毫无疑问的是所有请求都会经过代理，包括向DNS服务器发送的网络地址查询请求。

假设我在本地配置了代理客户端，服务器配置了代理服务器，他们之间通过某种协议传输；浏览器使用SOCKS5协议将请求转发给代理客户端。

现在解析 DNS question 在网络中的流程：

1. 浏览器不使用DNS服务，直接将请求封装到SOCKS5流量中发向代理客户端；
2. 代理客户端将SOCKS5解析成某种协议的规范然后传输给代理服务器；
3. 代理服务器获取到某种协议的流量，将该流量解析获取到其中域名；
4. 代理服务器查询域名对应的IP，代理客户端没有设置DNS Server的情况下会直接使用操作系统的`getaddrinfo`方法，反之则使用设置的DNS Server。

如果代理服务器在远端上，那么DNS查询也是发生在远端上的。

### 基于规则流量转发代理

相比较全局代理，该代理方式多了一步流量判断地域，判断流量地域可以通过域名或者IP。

优势是可以减少流量发送的路径、提高网络响应速度，同时降低服务端的流量使用和资源负载；但缺点是增加了本地客户端的负载，同时还会出现对DNS解析更多的需求，下面我们慢慢分析。

假设我们的流量全是域名：

**基于域名规则分流**根据设置的域名代理规则，需要代理的流量其DNS解析流程和**全局代理**相同，不需要代理的流量遵守默认的DNS行为。

**基于IP规则分流**相比较**基于域名规则分流**需要代理客户端先通过DNS服务解析IP才能够判断收否应该分流，这就导致我们需要在判断流量和业务使用时都需要DNS解析。

*实际情况下，我们访问的未必全是域名，所以正确的用法是域名的使用基于域名规则分流、IP的使用基于IP规则分流，这样就可以减少DNS解析次数。*

### TUN透明代理

**TUN**与**TAP**是操作系统内核中的虚拟网络设备，并向运行于操作系统上的软件提供与硬件的网络设备完全相同的功能。相当于外接了一台用于网络的计算机，本机的流量全部转发到那台计算机，那台计算机负责分流、DNS查询等等网络相关操作。

**为什么设置TUN模式浏览器不生效**

因为浏览器使用的是https，代理客户端无法正确解析，需要在系统设置使用了代理。

## 关于Fake IP

### 什么是Fake IP

当用户发送 DNS 请求时，代理并不发送请求到远程 DNS 服务器，而是为每个域名返回一个唯一假 IP。在指向这些假 IP 的流量发送到代理时，按查询得到的域名重置当前连接的目标。

目的是为了防止DNS欺诈。

### DNS欺诈

DNS question 本质上也是网络请求，因此网络链路的其中的某一跳可以实现返回一个错误的 IP 地址，而不没有到达你所指定的DNS服务器，因此也无法获得真正的域名解析结果。

### 代价

返回错误的 IP 会污染本地 DNS 缓存，使得代理断开之后一段时间内设备无法访问网络。



