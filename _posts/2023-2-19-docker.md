# Docker

## Preface

### What is image

[镜像](https://zh.wikipedia.org/wiki/ISO%E6%98%A0%E5%83%8F)是[磁盘映像](https://zh.wikipedia.org/wiki/%E7%A3%81%E7%9B%98%E6%98%A0%E5%83%8F)，包含一个磁盘卷或数据存储设备的**内容和结构**。

你可以认为他拥有一个硬盘的所有信息，所以平时下载的各种Linux发行版镜像，都可以通过刻录镜像还原一个镜像系统。

## Install

为了让当前用户能够有权限使用docker，将当前用户加入到`docker`组：

```sh
sudo usermod -a -G docker <USER_NAME>
```

## Command Line

### Info

刚上手docker的新手可以通过下面命令了解docker。

```sh
# 查看版本
docker version
# 查看信息
docker info
# 查看帮助
docker <command> -h
```

### Search

探索发现镜像。

```sh
docker search [OPTIONS] TERM

root@ninja:~# docker search mysql
NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
mysql                             MySQL is a widely used, open-source relation…   11243     [OK]       
mariadb                           MariaDB Server is a high performing open sou…   4274      [OK]       
mysql/mysql-server                Optimized MySQL Server Docker images. Create…   835                  [OK]
percona                           Percona Server is a fork of the MySQL relati…   548       [OK]       
phpmyadmin                        phpMyAdmin - A web interface for MySQL and M…   293       [OK]       
```

### Pull

拿来吧你！

获取你想要的镜像。

```sh
docker pull [OPTIONS] NAME[:TAG|@DIGEST]
```

### Image

把弄镜像！

```sh
# 查看所有镜像
docker image list
# or 
docker images [-a -q]

# 删除镜像
docker image rm <iamge-name>
# or
docker rmi <iamge-name>
```

The meaning of fields for `docker imnage list`:
| fields     | meaning  |
| ---------- | -------- |
| REPOSITORY | 镜像仓库 |
| TAG        | 镜像标签 |
| IMAGE ID   | 镜像编号 |
| CREATED    | 创建时间 |
| SIZE       | 镜像大小 |

### Run

跑起来吧，容器！

运行格式：

```sh
docker run [OPTIONS] IMAGE [COMMAND] [ARG...]
# Common options:
# -i        interactive
# -t        tty
# --rm      remove the container when it exits automatically
# -d        detach the tty, run container background and print container id
# -e        set the environment variable
# -v        bind mount a volume
```

常见的用法：

```sh
# 与tty交互运行，容器停止后自动删除
docker run -it --rm <image> --name <container-name>

# 数据库的后台运行
docker run -d \
	--name some-postgres \
	-e POSTGRES_PASSWORD=mysecretpassword \
	-e PGDATA=/var/lib/postgresql/data/pgdata \
	-v /custom/mount:/var/lib/postgresql/data \
	postgres
```

容器第一次运行（初始化）时指定的参数无法通过命令行修改，比如环境变量、映射端口、挂载等，容器名称可以修改。

（不推荐）但可以通过修改配置文件的方法修改初始化参数，再重启docker服务：

```sh
vim /var/lib/docker/containers/container-ID/config.v2.json
systemctl start docker.service
```

初始化参数不能修改是符合常识的，如我们启动容器PostgreSQL服务，他的环境变量用于初始化密码，挂载卷用于存储数据，当我们修改任意参数都会造成一定影响，初始化后修改密码环境变量并不会重设密码反而与约定俗成冲突造成误解，修改逻辑卷会影响数据库的数据。

### Container

容器常见操作：

```sh
# 查看容器
docker container list [-a]
# or
docker ps [-a]

# 停止容器
docker container stop <cotainer-id>
# 启动容器
docker container start <cotainer-id>
# or 
docker stop <cotainer-id>
```

### Exec

执行主任下达的命令！

Container在运行的时候可以执行命令：

```sh
docker exec [OPT] <CONTAINER_ID> <COMMAND>
# 比如，以交互的方式执行bash
docker exec -it 9d444a77cd9c bash
```

### Inspect

镜像容器都是我的！脱光看看！

```shell
docker inspect <iamge-id/container-id>
```

### Commit

打包容器到镜像（~~打回原形~~）。run命令使得我们的镜像变成了容器，那么怎么把容器再变回镜像呢？

```shell
docker commit <container-id> <image-name:version>
```

### Push

发布自己的镜像。

```sh
# 请注意镜像名格式应为`用户名/应用名`，否则无法发布镜像
docker push [OPTIONS] <IMAGE_NAME>:[TAG]
```

#### 获取镜像的途径

通过已有的容器构建成镜像：

```
docker commit [OPTIONS] CONTAINER [CONTAINER_NAME[:TAG]]
```

通过 `Dockerfile` 构建镜像：

```sh
docker build -t <tag_name> <directory>
# for example
docker build -t my-app .
```

实际上Dockerfile只是的一种的更直观的表达，在实际的使用中如果基于某个镜像，依然会将该镜像创建，然后执行 RUN COPY等命令，最后构建成镜像后将容器销毁。

## Docker Compose

上面聊的都是命令行来运行docker容器，毫无疑问创建容器指定参数是一个令人费神的操作，容器是反复运行同一个或者同时运行多个容器。

Docker Compose 可以指定单机的容器编排，通过编写 `yml` 持久化创建方法，同时可以创建多个以及前后依赖。

编写好 `docker-compose.yml` 后，可以使用下述命令：

```sh
# start
docker-compose up 
# -d: Run containers in the background.
# --build: Build images before starting containers.
# --force-recreate: Recreate containers even if their configuration and image haven't changed.
# stop
docker-compose down
# --volumes: Remove named volumes declared in the Compose file and anonymous volumes attached to containers.
# --remove-orphans: Remove containers for services not defined in the Compose file.
```

## MAC Tips

我们知道 docker 基于 linux 的，所以 mac 和 windows 上不能够直接运行 docker 命令，但是 mac 通过 `docker info` 命令可以发现 其实你可以制定一个远程的守护进程，也就是服务端。通过这个方式我们可以不用下载 docker desktop，仅仅只需要一个虚拟机/服务器，然后在环境变量中指出

```sh
export DOCKER_HOST=ssh://root@warrior.hihusky.com
```

你也可以指出 docker 的 context， 表明 来历

```sh
docker context create lima-docker --docker "host=unix:///Users/ming/.lima/docker/sock/docker.sock"
```
